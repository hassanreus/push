# On vide les règles déjà existantes
iptables -t filter -F
iptables -t filter -X

# On refuse toutes les connexions
iptables -t filter -P INPUT DROP
iptables -t filter -P FORWARD DROP
iptables -t filter -P OUTPUT ACCEPT

# On autorise les connexions déjà établie
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# On autorise le loop-back (localhost)
iptables -t filter -A INPUT -i lo -j ACCEPT

# Lastly reject All INPUT traffic
#iptables -A INPUT -j LOG
#iptables -A OUTPUT -j LOG

# Protecting portscans
# Attacking IP will be locked for 24 hours (3600 x 24 = 86400 Seconds)
#iptables -A INPUT -m recent --name portscan --rcheck --seconds 600 -j DROP
#iptables -A FORWARD -m recent --name portscan --rcheck --seconds 600 -j DROP

# Remove attacking IP after 24 hours
#iptables -A INPUT -m recent --name portscan --remove
#iptables -A FORWARD -m recent --name portscan --remove

# These rules add scanners to the portscan list, and log the attempt.
#iptables -A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j LOG --log-prefix "portscan:"
#iptables -A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j DROP

#iptables -A FORWARD -p tcp -m tcp --dport 139 -m recent --name portscan --set -j LOG --log-prefix "portscan:"
#iptables -A FORWARD -p tcp -m tcp --dport 139 -m recent --name portscan --set -j DROP

# HTTP - HTTPS - SSH
iptables -t filter -A INPUT -p tcp --dport 2212 -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -t filter -A INPUT -p tcp --dport 443 -j ACCEPT

# Lastly reject All INPUT traffic
#iptables -A INPUT -j REJECT

